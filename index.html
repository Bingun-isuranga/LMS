<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles to ensure Inter font and smooth transitions */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f3f4f6;
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center center;
            display: flex;
            min-height: 100vh;
        }
        #dashboard-section {
            background-image: url('background.jpg');
            background-repeat: no-repeat;
            background-position: center center;
            min-height: 650px; /* Adjust as needed */
        }
        .sidebar {
            width: 250px;
            background-color: #1f2937; /* Darker gray for sidebar */
            color: #ffffff;
            padding: 1.5rem 0;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }
        .content {
            flex-grow: 1;
            padding: 2rem;
            background-color: #ffffff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            margin: 1rem;
            position: relative; /* For modal positioning */
        }
        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: #d1d5db; /* Light gray text */
            text-decoration: none;
            transition: background-color 0.2s, color 0.2s;
            font-weight: 500;
        }
        .nav-item.active, .nav-item:hover {
            background-color: #374151; /* Slightly lighter dark gray on hover/active */
            color: #ffffff;
        }
        .nav-item svg {
            margin-right: 0.75rem;
            width: 1.25rem;
            height: 1.25rem;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #374151;
            text-transform: uppercase;
            font-size: 0.75rem;
        }
        tr:hover {
            background-color: #f3f4f6;
        }
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
            border: 1px solid transparent;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: #ffffff;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .btn-secondary {
            background-color: #6b7280;
            color: #ffffff;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        .btn-danger {
            background-color: #dc2626;
            color: #ffffff;
        }
        .btn-danger:hover {
            background-color: #b91c1c;
        }
        .btn-info {
            background-color: #3b82f6;
            color: #ffffff;
        }
        .btn-info:hover {
            background-color: #2563eb;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }
        .dashboard-card {
            background-color: #fff;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            text-align: center;
        }
        .hidden {
            display: none;
        }
        /* Style for the select in modals to ensure consistency */
        .modal select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            background-color: #fff;
            appearance: none; /* Remove default arrow */
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22 viewBox%3D%220 0 20 20%22 fill%3D%22%236B7280%22%3E%3Cpath fill-rule%3D%22evenodd%22 d%3D%22M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z%22 clip-rule%3D%22evenodd%22%3E%3C%2Fpath%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1rem;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div id="auth-page" class="flex flex-col items-center justify-center min-h-screen bg-gray-100 w-full">
        <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
            <h2 id="auth-title" class="text-2xl font-bold text-center mb-6">Login</h2>
            <form id="auth-form" class="space-y-4">
                <div>
                    <label for="username" class="block text-gray-700 text-sm font-bold mb-2">Username:</label>
                    <input type="text" id="username" name="username" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Password:</label>
                    <input type="password" id="password" name="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>

                <div id="signup-fields" class="hidden space-y-4">
                    <div>
                        <label for="role" class="block text-gray-700 text-sm font-bold mb-2">Role:</label>
                        <select id="role" name="role" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            <option value="student">Student</option>
                            <option value="teacher">Teacher</option>
                        </select>
                    </div>
                    <div id="student-signup-fields" class="space-y-4">
                        <div>
                            <label for="signup-name" class="block text-gray-700 text-sm font-bold mb-2">Full Name:</label>
                            <input type="text" id="signup-name" name="signup-name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div>
                            <label for="signup-admission-number" class="block text-gray-700 text-sm font-bold mb-2">Admission Number:</label>
                            <input type="text" id="signup-admission-number" name="signup-admission-number" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div>
                            <label for="signup-birthday" class="block text-gray-700 text-sm font-bold mb-2">Birthday:</label>
                            <input type="date" id="signup-birthday" name="signup-birthday" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div>
                            <label for="signup-telephone" class="block text-gray-700 text-sm font-bold mb-2">Telephone:</label>
                            <input type="tel" id="signup-telephone" name="signup-telephone" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div>
                            <label for="signup-address" class="block text-gray-700 text-sm font-bold mb-2">Address:</label>
                            <input type="text" id="signup-address" name="signup-address" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div>
                            <label for="signup-gender" class="block text-gray-700 text-sm font-bold mb-2">Gender:</label>
                            <select id="signup-gender" name="signup-gender" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                <option value="">Select Gender</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label for="signup-grade" class="block text-gray-700 text-sm font-bold mb-2">Grade:</label>
                            <input type="text" id="signup-grade" name="signup-grade" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                    </div>
                    <div id="teacher-signup-fields" class="hidden space-y-4">
                        <div>
                            <label for="signup-teacher-tag-name" class="block text-gray-700 text-sm font-bold mb-2">Teacher Tag Name:</label>
                            <input type="text" id="signup-teacher-tag-name" name="signup-teacher-tag-name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div>
                            <label for="signup-teacher-tag-number" class="block text-gray-700 text-sm font-bold mb-2">Teacher Tag Number:</label>
                            <input type="text" id="signup-teacher-tag-number" name="signup-teacher-tag-number" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div>
                            <label for="signup-teacher-grade" class="block text-gray-700 text-sm font-bold mb-2">Teacher Grade:</label>
                            <input type="text" id="signup-teacher-grade" name="signup-teacher-grade" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                    </div>
                    <p id="admin-signup-message" class="text-red-500 text-sm hidden">Admin accounts cannot be created via signup.</p>
                </div>
                <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full">Submit</button>
            </form>
            <p class="text-center text-gray-600 text-sm mt-4">
                <span id="auth-toggle-text">Don't have an account?</span>
                <button id="toggle-auth-mode" class="text-blue-500 hover:text-blue-800 font-bold ml-1">Sign Up</button>
            </p>
        </div>
    </div>

    <div id="main-app" class="hidden flex w-full">
        <div class="sidebar">
            <h1 class="text-2xl font-bold text-center mb-8">Library</h1>
            <nav class="flex-grow">
                <ul>
                    <li><a href="#" class="nav-item active" data-section="dashboard-section">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m0 0l-7 7m7-7v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                        Dashboard
                    </a></li>
                    <li><a href="#" class="nav-item" data-section="books-section">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                        Books
                    </a></li>
                    <li><a href="#" class="nav-item" data-section="members-section">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H2v-2a3 3 0 015.356-1.857M17 20h1V6a1 1 0 00-1-1H4a1 1 0 00-1 1v14h1m6-11h4m-4 0h4m-4 0v4m-4 0v4m-4 0v4m-4 0v4"></path></svg>
                        Members
                    </a></li>
                    <li><a href="#" class="nav-item" data-section="teachers-section">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H2v-2a3 3 0 015.356-1.857M17 20h1V6a1 1 0 00-1-1H4a1 1 0 00-1 1v14h1m6-11h4m-4 0h4m-4 0v4m-4 0v4m-4 0v4m-4 0v4"></path></svg>
                        Teachers
                    </a></li>
                    <li><a href="#" class="nav-item" data-section="transactions-section">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
                        Transactions
                    </a></li>
                </ul>
            </nav>
            <div class="mt-auto p-4">
                <button id="logout-btn" class="btn btn-secondary w-full">
                    <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    Logout
                </button>
            </div>
        </div>

        <div class="content">
            <section id="dashboard-section" class="hidden">
                <div class="header">
                    <h2 class="text-3xl font-bold text-gray-800">Dashboard</h2>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="dashboard-card">
                        <h3 class="text-xl font-semibold text-gray-700">Total Books</h3>
                        <p id="total-books" class="text-4xl font-bold text-blue-600 mt-2">0</p>
                    </div>
                    <div class="dashboard-card">
                        <h3 class="text-xl font-semibold text-gray-700">Available Books</h3>
                        <p id="available-books" class="text-4xl font-bold text-green-600 mt-2">0</p>
                    </div>
                    <div class="dashboard-card">
                        <h3 class="text-xl font-semibold text-gray-700">Issued Books</h3>
                        <p id="issued-books" class="text-4xl font-bold text-red-600 mt-2">0</p>
                    </div>
                    <div class="dashboard-card">
                        <h3 class="text-xl font-semibold text-gray-700">Total Members</h3>
                        <p id="total-members" class="text-4xl font-bold text-purple-600 mt-2">0</p>
                    </div>
                    <div class="dashboard-card">
                        <h3 class="text-xl font-semibold text-gray-700">Total Teachers</h3>
                        <p id="total-teachers" class="text-4xl font-bold text-teal-600 mt-2">0</p>
                    </div>
                </div>
            </section>

            <section id="books-section" class="hidden">
                <div class="header">
                    <h2 class="text-3xl font-bold text-gray-800">Books Management</h2>
                    <div class="flex items-center space-x-4">
                        <input type="text" id="book-search" placeholder="Search books..." class="px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button class="btn btn-primary" onclick="showModal('add-book-modal')">Add New Book</button>
                    </div>
                </div>

                <div class="table-container">
                    <table id="books-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Title</th>
                                <th>Author</th>
                                <th>ISBN</th>
                                <th>Publisher</th>
                                <th>Pages</th>
                                <th>Total Stock</th>
                                <th>Available Stock</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </section>

            <section id="members-section" class="hidden">
                <div class="header">
                    <h2 class="text-3xl font-bold text-gray-800">Members Management</h2>
                    <div class="flex items-center space-x-4">
                        <input type="text" id="member-search" placeholder="Search members..." class="px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button class="btn btn-primary" onclick="showModal('add-member-modal')">Add New Member</button>
                    </div>
                </div>

                <div class="table-container">
                    <table id="members-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Admission No.</th>
                                <th>Birthday</th>
                                <th>Telephone</th>
                                <th>Address</th>
                                <th>Gender</th>
                                <th>Grade</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </section>

            <section id="teachers-section" class="hidden">
                <div class="header">
                    <h2 class="text-3xl font-bold text-gray-800">Teachers Management</h2>
                    <div class="flex items-center space-x-4">
                        <input type="text" id="teacher-search" placeholder="Search teachers..." class="px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button class="btn btn-primary" onclick="showModal('add-teacher-modal')">Add New Teacher</button>
                    </div>
                </div>

                <div class="table-container">
                    <table id="teachers-table">
                        <thead>
                            <tr>
                                <th>Tag Name</th>
                                <th>Tag Number</th>
                                <th>Grade</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </section>

            <section id="transactions-section" class="hidden">
                <div class="header">
                    <h2 class="text-3xl font-bold text-gray-800">Transactions</h2>
                    <div class="flex items-center space-x-4">
                        <input type="text" id="transaction-search" placeholder="Search transactions..." class="px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button class="btn btn-primary" onclick="showModal('issue-book-modal')">Issue Book</button>
                    </div>
                </div>

                <div class="table-container">
                    <table id="transactions-table">
                        <thead>
                            <tr>
                                <th>Transaction ID</th>
                                <th>Book Title</th>
                                <th>Recipient Name</th>
                                <th>Recipient Type</th>
                                <th>Issue Date</th>
                                <th>Return Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </section>
        </div>
    </div>

    <div id="confirmation-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4" id="confirmation-title">Confirm Action</h3>
            <p id="confirmation-message" class="mb-6">Are you sure you want to proceed?</p>
            <div class="modal-footer">
                <button class="btn btn-secondary mr-2" onclick="closeModal('confirmation-modal')">Cancel</button>
                <button class="btn btn-danger" id="confirm-action-btn">Confirm</button>
            </div>
        </div>
    </div>

    <div id="info-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4" id="info-title">Information</h3>
            <p id="info-message" class="mb-6"></p>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeModal('info-modal')">OK</button>
            </div>
        </div>
    </div>

    <div id="add-book-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">Add New Book</h3>
            <form id="add-book-form" class="space-y-4">
                <div>
                    <label for="book-id" class="block text-gray-700 text-sm font-bold mb-2">Book ID:</label>
                    <input type="text" id="book-id" name="book-id" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="book-title" class="block text-gray-700 text-sm font-bold mb-2">Title:</label>
                    <input type="text" id="book-title" name="book-title" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="book-author" class="block text-gray-700 text-sm font-bold mb-2">Author:</label>
                    <input type="text" id="book-author" name="book-author" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="book-isbn" class="block text-gray-700 text-sm font-bold mb-2">ISBN:</label>
                    <input type="text" id="book-isbn" name="book-isbn" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="book-publisher" class="block text-gray-700 text-sm font-bold mb-2">Publisher:</label>
                    <input type="text" id="book-publisher" name="book-publisher" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="book-pages" class="block text-gray-700 text-sm font-bold mb-2">Pages:</label>
                    <input type="number" id="book-pages" name="book-pages" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="book-stock" class="block text-gray-700 text-sm font-bold mb-2">Stock:</label>
                    <input type="number" id="book-stock" name="book-stock" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary mr-2" onclick="closeModal('add-book-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Book</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-book-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">Edit Book</h3>
            <form id="edit-book-form" class="space-y-4">
                <input type="hidden" id="edit-book-id">
                <div>
                    <label for="edit-book-title" class="block text-gray-700 text-sm font-bold mb-2">Title:</label>
                    <input type="text" id="edit-book-title" name="title" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="edit-book-author" class="block text-gray-700 text-sm font-bold mb-2">Author:</label>
                    <input type="text" id="edit-book-author" name="author" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="edit-book-isbn" class="block text-gray-700 text-sm font-bold mb-2">ISBN:</label>
                    <input type="text" id="edit-book-isbn" name="isbn" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="edit-book-publisher" class="block text-gray-700 text-sm font-bold mb-2">Publisher:</label>
                    <input type="text" id="edit-book-publisher" name="publisher" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="edit-book-pages" class="block text-gray-700 text-sm font-bold mb-2">Pages:</label>
                    <input type="number" id="edit-book-pages" name="pages" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="edit-book-stock" class="block text-gray-700 text-sm font-bold mb-2">Stock:</label>
                    <input type="number" id="edit-book-stock" name="stock" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary mr-2" onclick="closeModal('edit-book-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="add-member-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">Add New Member</h3>
            <form id="add-member-form" class="space-y-4">
                <div>
                    <label for="member-name" class="block text-gray-700 text-sm font-bold mb-2">Name:</label>
                    <input type="text" id="member-name" name="name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="member-admission-number" class="block text-gray-700 text-sm font-bold mb-2">Admission Number:</label>
                    <input type="text" id="member-admission-number" name="admission-number" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="member-birthday" class="block text-gray-700 text-sm font-bold mb-2">Birthday:</label>
                    <input type="date" id="member-birthday" name="birthday" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="member-telephone" class="block text-gray-700 text-sm font-bold mb-2">Telephone:</label>
                    <input type="tel" id="member-telephone" name="telephone" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="member-address" class="block text-gray-700 text-sm font-bold mb-2">Address:</label>
                    <input type="text" id="member-address" name="address" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="member-gender" class="block text-gray-700 text-sm font-bold mb-2">Gender:</label>
                    <select id="member-gender" name="gender" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div>
                    <label for="member-grade" class="block text-gray-700 text-sm font-bold mb-2">Grade:</label>
                    <input type="text" id="member-grade" name="grade" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary mr-2" onclick="closeModal('add-member-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Member</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-member-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">Edit Member</h3>
            <form id="edit-member-form" class="space-y-4">
                <input type="hidden" id="edit-member-original-admission-number">
                <div>
                    <label for="edit-member-name" class="block text-gray-700 text-sm font-bold mb-2">Name:</label>
                    <input type="text" id="edit-member-name" name="name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="edit-member-admission-number" class="block text-gray-700 text-sm font-bold mb-2">Admission Number:</label>
                    <input type="text" id="edit-member-admission-number" name="admission-number" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="edit-member-birthday" class="block text-gray-700 text-sm font-bold mb-2">Birthday:</label>
                    <input type="date" id="edit-member-birthday" name="birthday" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="edit-member-telephone" class="block text-gray-700 text-sm font-bold mb-2">Telephone:</label>
                    <input type="tel" id="edit-member-telephone" name="telephone" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="edit-member-address" class="block text-gray-700 text-sm font-bold mb-2">Address:</label>
                    <input type="text" id="edit-member-address" name="address" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="edit-member-gender" class="block text-gray-700 text-sm font-bold mb-2">Gender:</label>
                    <select id="edit-member-gender" name="gender" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div>
                    <label for="edit-member-grade" class="block text-gray-700 text-sm font-bold mb-2">Grade:</label>
                    <input type="text" id="edit-member-grade" name="grade" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary mr-2" onclick="closeModal('edit-member-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="add-teacher-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">Add New Teacher</h3>
            <form id="add-teacher-form" class="space-y-4">
                <div>
                    <label for="teacher-tag-name" class="block text-gray-700 text-sm font-bold mb-2">Tag Name:</label>
                    <input type="text" id="teacher-tag-name" name="tag-name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="teacher-tag-number" class="block text-gray-700 text-sm font-bold mb-2">Tag Number:</label>
                    <input type="text" id="teacher-tag-number" name="tag-number" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="teacher-grade" class="block text-gray-700 text-sm font-bold mb-2">Grade:</label>
                    <input type="text" id="teacher-grade" name="grade" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary mr-2" onclick="closeModal('add-teacher-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Teacher</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-teacher-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">Edit Teacher</h3>
            <form id="edit-teacher-form" class="space-y-4">
                <input type="hidden" id="edit-teacher-original-tag-number">
                <div>
                    <label for="edit-teacher-tag-name" class="block text-gray-700 text-sm font-bold mb-2">Tag Name:</label>
                    <input type="text" id="edit-teacher-tag-name" name="tag-name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="edit-teacher-tag-number" class="block text-gray-700 text-sm font-bold mb-2">Tag Number:</label>
                    <input type="text" id="edit-teacher-tag-number" name="tag-number" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="edit-teacher-grade" class="block text-gray-700 text-sm font-bold mb-2">Grade:</label>
                    <input type="text" id="edit-teacher-grade" name="grade" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary mr-2" onclick="closeModal('edit-teacher-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="issue-book-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">Issue Book</h3>
            <form id="issue-book-form" class="space-y-4">
                <div>
                    <label for="transaction-id" class="block text-gray-700 text-sm font-bold mb-2">Transaction ID (Optional):</label>
                    <input type="text" id="transaction-id" name="transaction-id" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div>
                    <label for="issue-book-select" class="block text-gray-700 text-sm font-bold mb-2">Select Book:</label>
                    <select id="issue-book-select" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        </select>
                </div>
                <div>
                    <label for="issue-recipient-select" class="block text-gray-700 text-sm font-bold mb-2">Select Recipient (Student/Teacher):</label>
                    <select id="issue-recipient-select" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary mr-2" onclick="closeModal('issue-book-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Issue Book</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        let books = [];
        let members = [];
        let teachers = []; // New array for teachers
        let transactions = [];
        let users = []; // Array to store user credentials
        let currentUser = null; // Stores currently logged-in user

        // Helper to generate unique IDs if needed
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // --- Data Persistence Functions ---
        function saveData() {
            try {
                localStorage.setItem('libraryBooks', JSON.stringify(books));
                localStorage.setItem('libraryMembers', JSON.stringify(members));
                localStorage.setItem('libraryTransactions', JSON.stringify(transactions));
                localStorage.setItem('libraryUsers', JSON.stringify(users)); // Save users
                localStorage.setItem('libraryTeachers', JSON.stringify(teachers)); // Save teachers
                console.log("Data saved to localStorage.");
            } catch (e) {
                console.error("Error saving data to localStorage:", e);
                showModal("Error", "Could not save data. Your browser's storage might be full or disabled.", false);
            }
        }

        function loadData() {
            try {
                const storedBooks = localStorage.getItem('libraryBooks');
                const storedMembers = localStorage.getItem('libraryMembers');
                const storedTransactions = localStorage.getItem('libraryTransactions');
                const storedUsers = localStorage.getItem('libraryUsers'); // Load users
                const storedTeachers = localStorage.getItem('libraryTeachers'); // Load teachers

                books = storedBooks ? JSON.parse(storedBooks) : [];
                members = storedMembers ? JSON.parse(storedMembers) : [];
                transactions = storedTransactions ? JSON.parse(storedTransactions) : [];
                users = storedUsers ? JSON.parse(storedUsers) : []; // Parse users
                teachers = storedTeachers ? JSON.parse(storedTeachers) : []; // Parse teachers
                console.log("Data loaded from localStorage.");

                // Ensure a default admin user exists
                if (!users.some(user => user.username === 'admin' && user.role === 'admin')) {
                    users.push({ username: 'admin', password: 'admin123', role: 'admin' });
                    saveData(); // Save immediately after adding default admin
                    console.log("Default admin user added.");
                }
            } catch (e) {
                console.error("Error loading data from localStorage:", e);
                showModal("Error", "Could not load data. Local storage might be corrupted.", false);
                // Reset data if corrupted
                books = [];
                members = [];
                transactions = [];
                users = [];
                teachers = [];
            }
        }

        // --- UI Control Functions ---
        function showMainApp() {
            document.getElementById('auth-page').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            updateDashboardCounts();
            renderBooksTable();
            renderMembersTable();
            renderTeachersTable(); // Render teachers table
            renderTransactionsTable();
            populateIssueBookSelect();
            populateIssueRecipientSelect();
        }

        function showAuthPage() {
            document.getElementById('auth-page').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('auth-form').reset();
            document.getElementById('auth-title').innerText = 'Login';
            document.getElementById('auth-toggle-text').innerText = "Don't have an account?";
            document.getElementById('toggle-auth-mode').innerText = "Sign Up";
            document.getElementById('signup-fields').classList.add('hidden');
            document.getElementById('admin-signup-message').style.display = 'none';
        }

        function toggleAuthMode() {
            const authTitle = document.getElementById('auth-title');
            const toggleText = document.getElementById('auth-toggle-text');
            const toggleBtn = document.getElementById('toggle-auth-mode');
            const signupFields = document.getElementById('signup-fields');
            const adminSignupMessage = document.getElementById('admin-signup-message');

            if (authTitle.innerText === 'Login') {
                authTitle.innerText = 'Sign Up';
                toggleText.innerText = 'Already have an account?';
                toggleBtn.innerText = 'Login';
                signupFields.classList.remove('hidden');
            } else {
                authTitle.innerText = 'Login';
                toggleText.innerText = "Don't have an account?";
                toggleBtn.innerText = 'Sign Up';
                signupFields.classList.add('hidden');
                adminSignupMessage.style.display = 'none';
                document.getElementById('auth-form').reset(); // Clear form on toggle
            }
            // Reset visibility of student/teacher specific fields
            document.getElementById('student-signup-fields').classList.remove('hidden');
            document.getElementById('teacher-signup-fields').classList.add('hidden');
            document.getElementById('role').value = 'student'; // Default to student
        }

        function showSection(sectionId) {
            document.querySelectorAll('section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');

            // Update active state in sidebar
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.nav-item[data-section="${sectionId}"]`).classList.add('active');
        }

        function showModal(modalId, title = '', message = '', isSuccess = true) {
            const modal = document.getElementById(modalId);
            if (!modal) return; // Exit if modal does not exist

            if (modalId === 'info-modal' || modalId === 'confirmation-modal') {
                document.getElementById(`${modalId === 'info-modal' ? 'info' : 'confirmation'}-title`).innerText = title;
                document.getElementById(`${modalId === 'info-modal' ? 'info' : 'confirmation'}-message`).innerText = message;
                // For info modal, change button color based on success/error
                if (modalId === 'info-modal') {
                    const okBtn = modal.querySelector('.btn-primary');
                    okBtn.classList.remove('btn-primary', 'btn-danger');
                    if (isSuccess) {
                        okBtn.classList.add('btn-primary');
                    } else {
                        okBtn.classList.add('btn-danger');
                    }
                }
            }
            modal.classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            document.getElementById(`${modalId.replace('-modal', '')}-form`).reset(); // Reset form inside modal
        }

        function showConfirmationModal(message, callback) {
            document.getElementById('confirmation-message').innerText = message;
            document.getElementById('confirm-action-btn').onclick = () => {
                callback();
                closeModal('confirmation-modal');
            };
            showModal('confirmation-modal', 'Confirm Action', message);
        }

        // --- Render Table Functions ---
        function renderBooksTable() {
            const tableBody = document.querySelector('#books-table tbody');
            tableBody.innerHTML = '';
            const searchTerm = document.getElementById('book-search').value.toLowerCase();
            const filteredBooks = books.filter(book =>
                book.title.toLowerCase().includes(searchTerm) ||
                book.author.toLowerCase().includes(searchTerm) ||
                book.isbn.toLowerCase().includes(searchTerm) ||
                book.id.toLowerCase().includes(searchTerm)
            );

            filteredBooks.forEach(book => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${book.id}</td>
                    <td>${book.title}</td>
                    <td>${book.author}</td>
                    <td>${book.isbn}</td>
                    <td>${book.publisher}</td>
                    <td>${book.pages}</td>
                    <td>${book.stock}</td>
                    <td>${book.available}</td>
                    <td class="whitespace-nowrap">
                        <button onclick="editBook('${book.id}')" class="btn btn-info btn-sm mr-2">Edit</button>
                        <button onclick="showConfirmationModal('Are you sure you want to delete this book?', () => deleteBook('${book.id}'))" class="btn btn-danger btn-sm">Delete</button>
                    </td>
                `;
            });
            updateDashboardCounts();
        }

        function renderMembersTable() {
            const tableBody = document.querySelector('#members-table tbody');
            tableBody.innerHTML = '';
            const searchTerm = document.getElementById('member-search').value.toLowerCase();
            const filteredMembers = members.filter(member =>
                member.name.toLowerCase().includes(searchTerm) ||
                member.admissionNumber.toLowerCase().includes(searchTerm) ||
                member.telephone.toLowerCase().includes(searchTerm)
            );

            filteredMembers.forEach(member => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${member.name}</td>
                    <td>${member.admissionNumber}</td>
                    <td>${member.birthday}</td>
                    <td>${member.telephone}</td>
                    <td>${member.address}</td>
                    <td>${member.gender}</td>
                    <td>${member.grade}</td>
                    <td class="whitespace-nowrap">
                        <button onclick="editMember('${member.admissionNumber}')" class="btn btn-info btn-sm mr-2">Edit</button>
                        <button onclick="showConfirmationModal('Are you sure you want to delete this member?', () => deleteMember('${member.admissionNumber}'))" class="btn btn-danger btn-sm">Delete</button>
                    </td>
                `;
            });
            updateDashboardCounts();
        }

        function renderTeachersTable() {
            const tableBody = document.querySelector('#teachers-table tbody');
            tableBody.innerHTML = '';
            const searchTerm = document.getElementById('teacher-search').value.toLowerCase();
            const filteredTeachers = teachers.filter(teacher =>
                teacher.tagName.toLowerCase().includes(searchTerm) ||
                teacher.tagNumber.toLowerCase().includes(searchTerm) ||
                teacher.grade.toLowerCase().includes(searchTerm)
            );

            filteredTeachers.forEach(teacher => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${teacher.tagName}</td>
                    <td>${teacher.tagNumber}</td>
                    <td>${teacher.grade}</td>
                    <td class="whitespace-nowrap">
                        <button onclick="editTeacher('${teacher.tagNumber}')" class="btn btn-info btn-sm mr-2">Edit</button>
                        <button onclick="showConfirmationModal('Are you sure you want to delete this teacher?', () => deleteTeacher('${teacher.tagNumber}'))" class="btn btn-danger btn-sm">Delete</button>
                    </td>
                `;
            });
            updateDashboardCounts();
        }

        function renderTransactionsTable() {
            const tableBody = document.querySelector('#transactions-table tbody');
            tableBody.innerHTML = '';
            const searchTerm = document.getElementById('transaction-search').value.toLowerCase();
            const filteredTransactions = transactions.filter(transaction =>
                transaction.bookTitle.toLowerCase().includes(searchTerm) ||
                transaction.recipientName.toLowerCase().includes(searchTerm) ||
                transaction.recipientType.toLowerCase().includes(searchTerm) ||
                transaction.status.toLowerCase().includes(searchTerm) ||
                transaction.id.toLowerCase().includes(searchTerm)
            );

            filteredTransactions.forEach(transaction => {
                const row = tableBody.insertRow();
                let actionsHtml = '';
                if (transaction.status === 'Issued') {
                    actionsHtml = `<button onclick="showConfirmationModal('Are you sure you want to return this book?', () => returnBook('${transaction.id}'))" class="btn btn-secondary btn-sm">Return</button>`;
                } else {
                    actionsHtml = '<span class="text-gray-500">N/A</span>';
                }

                row.innerHTML = `
                    <td>${transaction.id}</td>
                    <td>${transaction.bookTitle}</td>
                    <td>${transaction.recipientName}</td>
                    <td>${transaction.recipientType}</td>
                    <td>${transaction.issueDate}</td>
                    <td>${transaction.returnDate || 'N/A'}</td>
                    <td><span class="${transaction.status === 'Issued' ? 'text-red-600' : 'text-green-600'} font-semibold">${transaction.status}</span></td>
                    <td class="whitespace-nowrap">
                        ${actionsHtml}
                    </td>
                `;
            });
            updateDashboardCounts();
        }

        // --- Dashboard Count Update ---
        function updateDashboardCounts() {
            document.getElementById('total-books').innerText = books.length;
            document.getElementById('available-books').innerText = books.reduce((sum, book) => sum + book.available, 0);
            document.getElementById('issued-books').innerText = transactions.filter(t => t.status === 'Issued').length;
            document.getElementById('total-members').innerText = members.length;
            document.getElementById('total-teachers').innerText = teachers.length;
        }

        // --- Book Management Functions ---
        function addBook(event) {
            event.preventDefault();
            const id = document.getElementById('book-id').value;
            const title = document.getElementById('book-title').value;
            const author = document.getElementById('book-author').value;
            const isbn = document.getElementById('book-isbn').value;
            const publisher = document.getElementById('book-publisher').value;
            const pages = parseInt(document.getElementById('book-pages').value);
            const stock = parseInt(document.getElementById('book-stock').value);

            // Basic validation
            if (!id || !title || !author || !isbn || !publisher || isNaN(pages) || isNaN(stock)) {
                showModal("Error", "Please fill in all book fields correctly.", false);
                return;
            }

            if (books.some(book => book.id === id)) {
                showModal("Error", "Book ID already exists.", false);
                return;
            }

            const newBook = { id, title, author, isbn, publisher, pages, stock, available: stock };
            books.push(newBook);
            saveData(); // Added
            renderBooksTable();
            showSection('books-section');
            showModal('Success', 'Book added successfully!');
            document.getElementById('add-book-form').reset();
        }

        function editBook(bookId) {
            const book = books.find(b => b.id === bookId);
            if (book) {
                document.getElementById('edit-book-id').value = book.id;
                document.getElementById('edit-book-title').value = book.title;
                document.getElementById('edit-book-author').value = book.author;
                document.getElementById('edit-book-isbn').value = book.isbn;
                document.getElementById('edit-book-publisher').value = book.publisher;
                document.getElementById('edit-book-pages').value = book.pages;
                document.getElementById('edit-book-stock').value = book.stock;
                showModal('edit-book-modal');
            } else {
                showModal('Error', 'Book not found.', false);
            }
        }

        function saveEditedBook(event) {
            event.preventDefault();
            const bookId = document.getElementById('edit-book-id').value;
            const title = document.getElementById('edit-book-title').value;
            const author = document.getElementById('edit-book-author').value;
            const isbn = document.getElementById('edit-book-isbn').value;
            const publisher = document.getElementById('edit-book-publisher').value;
            const pages = parseInt(document.getElementById('edit-book-pages').value);
            const stock = parseInt(document.getElementById('edit-book-stock').value);

            // Basic validation
            if (!title || !author || !isbn || !publisher || isNaN(pages) || isNaN(stock)) {
                showModal("Error", "Please fill in all book fields correctly.", false);
                return;
            }

            const bookIndex = books.findIndex(book => book.id === bookId);
            if (bookIndex !== -1) {
                const oldStock = books[bookIndex].stock;
                const oldAvailable = books[bookIndex].available;
                const stockChange = stock - oldStock; // Positive if stock increased, negative if decreased

                books[bookIndex] = {
                    ...books[bookIndex],
                    title,
                    author,
                    isbn,
                    publisher,
                    pages,
                    stock,
                    available: oldAvailable + stockChange // Adjust available stock based on stock change
                };
                saveData(); // Added
                renderBooksTable();
                updateDashboardCounts();
                closeModal('edit-book-modal');
                showModal('Success', 'Book updated successfully!');
            } else {
                showModal('Error', 'Book not found.', false);
            }
        }

        function deleteBook(bookId) {
            books = books.filter(book => book.id !== bookId);
            saveData(); // Added
            renderBooksTable();
            updateDashboardCounts();
            showModal('Success', 'Book deleted successfully!');
        }

        // --- Member Management Functions ---
        function addMember(event) {
            event.preventDefault();
            const name = document.getElementById('member-name').value;
            const admissionNumber = document.getElementById('member-admission-number').value;
            const birthday = document.getElementById('member-birthday').value;
            const telephone = document.getElementById('member-telephone').value;
            const address = document.getElementById('member-address').value;
            const gender = document.getElementById('member-gender').value;
            const grade = document.getElementById('member-grade').value;

            if (!name || !admissionNumber || !birthday || !telephone || !address || !gender || !grade) {
                showModal("Error", "Please fill in all member fields.", false);
                return;
            }

            if (members.some(member => member.admissionNumber === admissionNumber)) {
                showModal("Error", "Member with this Admission Number already exists.", false);
                return;
            }

            const newMember = { name, admissionNumber, birthday, telephone, address, gender, grade };
            members.push(newMember);
            saveData(); // Added
            renderMembersTable();
            showSection('members-section');
            showModal('Success', 'Member added successfully!');
            document.getElementById('add-member-form').reset();
        }

        function editMember(admissionNumber) {
            const member = members.find(m => m.admissionNumber === admissionNumber);
            if (member) {
                document.getElementById('edit-member-original-admission-number').value = member.admissionNumber; // Store original for lookup
                document.getElementById('edit-member-name').value = member.name;
                document.getElementById('edit-member-admission-number').value = member.admissionNumber;
                document.getElementById('edit-member-birthday').value = member.birthday;
                document.getElementById('edit-member-telephone').value = member.telephone;
                document.getElementById('edit-member-address').value = member.address;
                document.getElementById('edit-member-gender').value = member.gender;
                document.getElementById('edit-member-grade').value = member.grade;
                showModal('edit-member-modal');
            } else {
                showModal('Error', 'Member not found.', false);
            }
        }

        function saveEditedMember(event) {
            event.preventDefault();
            const originalAdmissionNumber = document.getElementById('edit-member-original-admission-number').value;
            const name = document.getElementById('edit-member-name').value;
            const admissionNumber = document.getElementById('edit-member-admission-number').value;
            const birthday = document.getElementById('edit-member-birthday').value;
            const telephone = document.getElementById('edit-member-telephone').value;
            const address = document.getElementById('edit-member-address').value;
            const gender = document.getElementById('edit-member-gender').value;
            const grade = document.getElementById('edit-member-grade').value;

            if (!name || !admissionNumber || !birthday || !telephone || !address || !gender || !grade) {
                showModal("Error", "Please fill in all member fields.", false);
                return;
            }

            const memberIndex = members.findIndex(member => member.admissionNumber === originalAdmissionNumber);
            if (memberIndex !== -1) {
                members[memberIndex] = {
                    name,
                    admissionNumber,
                    birthday,
                    telephone,
                    address,
                    gender,
                    grade
                };
                saveData(); // Added
                renderMembersTable();
                updateDashboardCounts();
                closeModal('edit-member-modal');
                showModal('Success', 'Member updated successfully!');
            } else {
                showModal('Error', 'Member not found.', false);
            }
        }

        function deleteMember(admissionNumber) {
            members = members.filter(member => member.admissionNumber !== admissionNumber);
            saveData(); // Added
            renderMembersTable();
            updateDashboardCounts();
            showModal('Success', 'Member deleted successfully!');
        }

        // --- Teacher Management Functions ---
        function addTeacher(event) {
            event.preventDefault();
            const tagName = document.getElementById('teacher-tag-name').value;
            const tagNumber = document.getElementById('teacher-tag-number').value;
            const grade = document.getElementById('teacher-grade').value;

            if (!tagName || !tagNumber || !grade) {
                showModal("Error", "Please fill in all teacher fields.", false);
                return;
            }

            if (teachers.some(teacher => teacher.tagNumber === tagNumber)) {
                showModal("Error", "Teacher with this Tag Number already exists.", false);
                return;
            }

            const newTeacher = { tagName, tagNumber, grade };
            teachers.push(newTeacher);
            saveData(); // Added
            renderTeachersTable();
            showSection('teachers-section');
            showModal('Success', 'Teacher added successfully!');
            document.getElementById('add-teacher-form').reset();
        }

        function editTeacher(tagNumber) {
            const teacher = teachers.find(t => t.tagNumber === tagNumber);
            if (teacher) {
                document.getElementById('edit-teacher-original-tag-number').value = teacher.tagNumber;
                document.getElementById('edit-teacher-tag-name').value = teacher.tagName;
                document.getElementById('edit-teacher-tag-number').value = teacher.tagNumber;
                document.getElementById('edit-teacher-grade').value = teacher.grade;
                showModal('edit-teacher-modal');
            } else {
                showModal('Error', 'Teacher not found.', false);
            }
        }

        function saveEditedTeacher(event) {
            event.preventDefault();
            const originalTagNumber = document.getElementById('edit-teacher-original-tag-number').value;
            const tagName = document.getElementById('edit-teacher-tag-name').value;
            const tagNumber = document.getElementById('edit-teacher-tag-number').value;
            const grade = document.getElementById('edit-teacher-grade').value;

            if (!tagName || !tagNumber || !grade) {
                showModal("Error", "Please fill in all teacher fields.", false);
                return;
            }

            const teacherIndex = teachers.findIndex(teacher => teacher.tagNumber === originalTagNumber);
            if (teacherIndex !== -1) {
                if (tagNumber !== originalTagNumber && teachers.some(t => t.tagNumber === tagNumber)) {
                    showModal("Error", "Teacher with this new Tag Number already exists.", false);
                    return;
                }

                teachers[teacherIndex] = {
                    tagName,
                    tagNumber,
                    grade
                };
                saveData(); // Added
                renderTeachersTable();
                closeModal('edit-teacher-modal');
                showModal('Success', 'Teacher updated successfully!');
            } else {
                showModal('Error', 'Teacher not found.', false);
            }
        }

        function deleteTeacher(tagNumber) {
            teachers = teachers.filter(teacher => teacher.tagNumber !== tagNumber);
            saveData(); // Added
            renderTeachersTable();
            showModal('Success', 'Teacher deleted successfully!');
        }

        // --- Transaction Management Functions ---
        function populateIssueBookSelect() {
            const select = document.getElementById('issue-book-select');
            select.innerHTML = '<option value="">Select a Book</option>';
            books.filter(book => book.available > 0).forEach(book => {
                const option = document.createElement('option');
                option.value = book.id;
                option.textContent = `${book.title} (${book.available} available)`;
                select.appendChild(option);
            });
        }

        function populateIssueRecipientSelect() {
            const select = document.getElementById('issue-recipient-select');
            select.innerHTML = '<option value="">Select a Recipient</option>';
            members.forEach(member => {
                const option = document.createElement('option');
                option.value = `student-${member.admissionNumber}`;
                option.textContent = `Student: ${member.name} (${member.admissionNumber})`;
                select.appendChild(option);
            });
            teachers.forEach(teacher => {
                const option = document.createElement('option');
                option.value = `teacher-${teacher.tagNumber}`;
                option.textContent = `Teacher: ${teacher.tagName} (${teacher.tagNumber})`;
                select.appendChild(option);
            });
        }

        function issueBook(event) {
            event.preventDefault();
            const transactionId = document.getElementById('transaction-id').value || generateUniqueId();
            const bookId = document.getElementById('issue-book-select').value;
            const recipientId = document.getElementById('issue-recipient-select').value;
            const issueDate = new Date().toISOString().split('T')[0];

            if (!bookId || !recipientId) {
                showModal("Error", "Please select a book and a recipient.", false);
                return;
            }

            const book = books.find(b => b.id === bookId);
            if (!book || book.available <= 0) {
                showModal("Error", "Selected book is not available or out of stock.", false);
                return;
            }

            const [recipientType, actualRecipientId] = recipientId.split('-');
            let recipient;
            if (recipientType === 'student') {
                recipient = members.find(m => m.admissionNumber === actualRecipientId);
            } else if (recipientType === 'teacher') {
                recipient = teachers.find(t => t.tagNumber === actualRecipientId);
            }

            if (!recipient) {
                showModal("Error", "Selected recipient not found.", false);
                return;
            }

            // Check if the book is already issued to this recipient
            if (transactions.some(t => t.bookId === bookId && t.recipientId === actualRecipientId && t.status === 'Issued')) {
                showModal("Error", "This book is already issued to this recipient.", false);
                return;
            }

            // Check if the transaction ID already exists
            if (transactions.some(t => t.id === transactionId)) {
                showModal("Error", "Transaction ID already exists. Please try again or leave blank for auto-generation.", false);
                return;
            }

            book.available--; // Decrease available stock

            const newTransaction = {
                id: transactionId,
                bookId: book.id,
                bookTitle: book.title,
                recipientId: actualRecipientId,
                recipientName: recipient.name || recipient.tagName,
                recipientType: recipientType,
                issueDate: issueDate,
                returnDate: '',
                status: 'Issued'
            };
            transactions.push(newTransaction);
            saveData(); // Added
            renderBooksTable();
            renderTransactionsTable();
            updateDashboardCounts();
            closeModal('issue-book-modal');
            showSection('transactions-section');
            showModal('Success', `Book "${book.title}" issued to ${newTransaction.recipientName}.`);
            document.getElementById('issue-book-form').reset();
        }

        function returnBook(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (transaction && transaction.status === 'Issued') {
                transaction.status = 'Returned';
                transaction.returnDate = new Date().toISOString().split('T')[0];

                const book = books.find(b => b.id === transaction.bookId);
                if (book) {
                    book.available++; // Increase available stock
                }
                saveData(); // Added
                renderTransactionsTable();
                renderBooksTable(); // Update book table to reflect stock change
                updateDashboardCounts();
                showModal('Success', 'Book returned successfully!');
            } else {
                showModal('Error', 'Transaction not found or book already returned.', false);
            }
        }

        // --- User Authentication ---
        function handleAuthSubmit(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const authTitle = document.getElementById('auth-title').innerText; // "Login" or "Sign Up"

            if (authTitle === 'Login') {
                const user = users.find(u => u.username === username && u.password === password);
                if (user) {
                    currentUser = { username: user.username, role: user.role };
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    showMainApp();
                    renderDashboard();
                    showSection('dashboard-section');
                    showModal('Success', `Welcome, ${currentUser.username}!`);
                } else {
                    showModal('Error', 'Invalid username or password.', false);
                }
            } else if (authTitle === 'Sign Up') {
                const role = document.getElementById('role').value;

                if (users.some(u => u.username === username)) {
                    showModal('Error', 'Username already taken.', false);
                    return;
                }

                if (role === 'admin') {
                    document.getElementById('admin-signup-message').style.display = 'block';
                    return;
                }

                let newUser = { username, password, role };
                if (role === 'student') {
                    const signupName = document.getElementById('signup-name').value;
                    const signupAdmissionNumber = document.getElementById('signup-admission-number').value;
                    const signupBirthday = document.getElementById('signup-birthday').value;
                    const signupTelephone = document.getElementById('signup-telephone').value;
                    const signupAddress = document.getElementById('signup-address').value;
                    const signupGender = document.getElementById('signup-gender').value;
                    const signupGrade = document.getElementById('signup-grade').value;
                    if (!signupName || !signupAdmissionNumber || !signupBirthday || !signupTelephone || !signupAddress || !signupGender || !signupGrade) {
                        showModal("Error", "Please fill in all student details for signup.", false);
                        return;
                    }
                    if (members.some(m => m.admissionNumber === signupAdmissionNumber)) {
                        showModal("Error", "A student with this Admission Number already exists.", false);
                        return;
                    }
                    newUser = { ...newUser, name: signupName, admissionNumber: signupAdmissionNumber, birthday: signupBirthday, telephone: signupTelephone, address: signupAddress, gender: signupGender, grade: signupGrade };
                    members.push({ name: signupName, admissionNumber: signupAdmissionNumber, birthday: signupBirthday, telephone: signupTelephone, address: signupAddress, gender: signupGender, grade: signupGrade });
                } else if (role === 'teacher') {
                    const signupTeacherTagName = document.getElementById('signup-teacher-tag-name').value;
                    const signupTeacherTagNumber = document.getElementById('signup-teacher-tag-number').value;
                    const signupTeacherGrade = document.getElementById('signup-teacher-grade').value;
                    if (!signupTeacherTagName || !signupTeacherTagNumber || !signupTeacherGrade) {
                        showModal("Error", "Please fill in all teacher details for signup.", false);
                        return;
                    }
                    if (teachers.some(t => t.tagNumber === signupTeacherTagNumber)) {
                        showModal("Error", "A teacher with this Tag Number already exists.", false);
                        return;
                    }
                    newUser = { ...newUser, tagName: signupTeacherTagName, tagNumber: signupTeacherTagNumber, grade: signupTeacherGrade };
                    teachers.push({ tagName: signupTeacherTagName, tagNumber: signupTeacherTagNumber, grade: signupTeacherGrade });
                }
                users.push(newUser);
                saveData(); // Added
                showModal('Success', 'Account created successfully! You can now log in.');
                toggleAuthMode(); // Switch back to login view
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser'); // Clear current user from localStorage
            showAuthPage(); // Show login page
            showModal('Info', 'You have been logged out.', true);
        }

        // --- Event Listeners and Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData(); // Load data on startup

            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    showSection(this.dataset.section);
                });
            });

            // Authentication
            document.getElementById('toggle-auth-mode').addEventListener('click', toggleAuthMode);
            document.getElementById('auth-form').addEventListener('submit', handleAuthSubmit);
            document.getElementById('logout-btn').addEventListener('click', logout);

            // Conditional fields for signup
            document.getElementById('role').addEventListener('change', function() {
                if (this.value === 'student') {
                    document.getElementById('student-signup-fields').classList.remove('hidden');
                    document.getElementById('teacher-signup-fields').classList.add('hidden');
                } else if (this.value === 'teacher') {
                    document.getElementById('teacher-signup-fields').classList.remove('hidden');
                    document.getElementById('student-signup-fields').classList.add('hidden');
                }
            });

            // Forms submission
            document.getElementById('add-book-form').addEventListener('submit', addBook);
            document.getElementById('add-member-form').addEventListener('submit', addMember);
            document.getElementById('issue-book-form').addEventListener('submit', issueBook);
            document.getElementById('edit-book-form').addEventListener('submit', saveEditedBook);
            document.getElementById('edit-member-form').addEventListener('submit', saveEditedMember);
            document.getElementById('add-teacher-form').addEventListener('submit', addTeacher); // New: Add Teacher form submit
            document.getElementById('edit-teacher-form').addEventListener('submit', saveEditedTeacher); // New: Edit Teacher form submit


            // Search bar listeners (re-render table on input change)
            document.getElementById('book-search').addEventListener('input', renderBooksTable);
            document.getElementById('member-search').addEventListener('input', renderMembersTable);
            document.getElementById('teacher-search').addEventListener('input', renderTeachersTable); // New: Teacher search
            document.getElementById('transaction-search').addEventListener('input', renderTransactionsTable); // New: Transaction search

            // Check for logged-in user on load
            const storedUser = localStorage.getItem('currentUser');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                showMainApp();
            } else {
                showAuthPage();
            }

            // Initial render of the dashboard if logged in
            if (currentUser) {
                renderDashboard();
                showSection('dashboard-section'); // Show dashboard by default
            }
        });
    </script>
</body>
</html>
